<!-- HTML header for doxygen 1.8.18-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lua plugin documentation</title>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.2/cerulean/bootstrap.min.css" rel="stylesheet">
<link href="css/demo.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="doxy-boot.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<a href="https://github.com/meetecho/janus-gateway"><img style="position: absolute; top: 0; left: 0; border: 0; z-index: 2001;" src="forkme_left_darkblue_121621.png" alt="Fork me on GitHub"></a>
<div class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary">
<div class="container">
	<a class="navbar-brand" href="/">Janus (multistream)</a>
	<button type="button" class="navbar-toggler" data-toggle="collapse" data-target=".navbar-collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false">
		<span class="navbar-toggler-icon"></span>
	</button>
	<div class="navbar-collapse collapse" id="navbarResponsive">
		<ul class="navbar-nav">
			<li class="nav-item"><a class="nav-link" href="/">Home</a></li>
			<li class="nav-item"><a class="nav-link" href="/demos/">Demos</a></li>
			<li class="nav-item"><a class="nav-link active" href="index.html">Documentation</a></li>
			<li class="nav-item"><a class="nav-link" href="/citeus.html">Papers</a></li>
			<li class="nav-item"><a class="nav-link" href="/support.html">Need help?</a></li>
			<li class="nav-item"><a class="nav-link" href="https://janus-legacy.conf.meetecho.com/">Janus (0.x)</a></li>
			<li class="nav-item"><a class="nav-link januscon" target="_blank" href="https://januscon.it">JanusCon!</a></li>
		</ul>
		<ul class="navbar-nav ms-auto">
			<li class="nav-item">
				<a class="nav-link meetecho-logo" target="_blank" href="https://www.meetecho.com">
					<img src="meetecho-logo.png"/>
				</a>
			</li>
		</ul>
	</div>
</div>
</div>
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="topics.html"><span>Topics</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Lua plugin documentation</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is a plugin that implements a simple bridge to Lua scripts. While the plugin implements low level stuff like media manipulation, routing, recording, etc., all the logic is demanded to an external Lua script. This means that the C code exposes functions to the Lua script (e.g., to dictate what to do with media, whether recording should be done, sending PLIs, etc.), while Lua exposes functions to be notified by the C code about important events (e.g., new users, WebRTC state, incoming messages, etc.).</p>
<p>Considering the C code and the Lua script will need some sort of "contract" in order to be able to properly interact with each other, the interface (as in method names) must be consistent, but the logic in the Lua script can be completely customized, so that it fits whatever requirement one has (e.g., something like the EchoTest, or something like the VideoRoom).</p>
<h1><a class="anchor" id="luaapi"></a>
Lua interfaces</h1>
<p>Every Lua script that wants to implement a Janus plugin must provide the following functions as callbacks:</p>
<ul>
<li><code>init()</code>: called when <a class="el" href="janus__lua_8c.html" title="Janus Lua plugin.">janus_lua.c</a> is initialized;</li>
<li><code>destroy()</code>: called when <a class="el" href="janus__lua_8c.html" title="Janus Lua plugin.">janus_lua.c</a> is deinitialized (Janus shutting down);</li>
<li><code>createSession()</code>: called when a new user attaches to the Janus Lua plugin;</li>
<li><code>destroySession()</code>: called when an attached user detaches from the Janus Lua plugin;</li>
<li><code>querySession()</code>: called when an Admin API query for a specific user gets to the Janus Lua plugin;</li>
<li><code>handleMessage()</code>: called when a user sends a message to the Janus Lua plugin;</li>
<li><code>setupMedia()</code>: called when a users's WebRTC PeerConnection goes up;</li>
<li><code>hangupMedia()</code>: called when a users's WebRTC PeerConnection goes down;</li>
<li><code>resumeScheduler()</code>: called by the C scheduler to resume coroutines.</li>
</ul>
<p>While <code>init()</code> expects a path to a config file (which you can ignore if unneeded), and <code>destroy()</code> and <code>resumeScheduler()</code> don't need any argument, all other functions expect at the very least a numeric session identifier, that will uniquely address a user in the plugin. Such a value is created dynamically by the C code, and so all the Lua script needs to do is track it as a unique session identifier when handling requests and pushing responses/events/actions towards the C code. Refer to the existing examples (e.g., <code>echotest.lua</code>) to see the exact signature for all the above callbacks.</p>
<dl class="section note"><dt>Note</dt><dd>Notice that, along the above mentioned callbacks, Lua scripts can also implement functions like <code>incomingRtp()</code> <code>incomingRtcp()</code> <code>incomingTextData()</code> and <code>incomingBinaryData()</code> to handle those packets directly, instead of letting the C code worry about relaying/processing them. While it might make sense to handle incoming data channel messages with <code>incomingTextData()</code> or <code>incomingBinaryData</code> though, the performance impact of directly processing and manipulating RTP an RTCP packets is probably too high, and so their usage is currently discouraged. The <code>dataReady()</code> callback can be used to figure out when data can be sent. As an additional note, Lua scripts can also decide to implement the functions that return information about the plugin itself, namely <code>getVersion()</code> <code>getVersionString()</code> <code>getDescription()</code> <code>getName()</code> <code>getAuthor()</code> and <code>getPackage()</code>. If not implemented, the Lua plugin will return its own info (i.e., "janus.plugin.lua", etc.). Most of the times, Lua scripts will not need to override this information, unless they really want to register their own name spaces and versioning. Lua scripts can also receive information on slow links via the <code>slowLink()</code> callback, in order to react accordingly: e.g., reduce the bitrate of a video sender if they, or their viewers, are experiencing issues. Finally, in case simulcast is used, Lia scripts may receive events on substream and/or temporal layer changes happening for receiving sessions via the <code>substreamChanged()</code> and the <code>temporalLayerChanged()</code> callbacks: this may be useful to track which layer is actually being sent, vs. what was requested.</dd></dl>
<h1><a class="anchor" id="capi"></a>
C interfaces</h1>
<p>Just as the Lua script needs to expose callbacks that the C code can invoke, the C code exposes methods as Lua functions accessible from the Lua script. This includes means to push events, configure how media should be routed without handling each packet in Lua, sending RTCP feedback, start/stop recording and so on.</p>
<p>The following are the functions the C code exposes:</p>
<ul>
<li><code>pushEvent()</code>: push an event to the user via Janus API;</li>
<li><code>eventsIsEnabled()</code>: check if Event Handlers are enabled in the core;</li>
<li><code>notifyEvent()</code>: send an event to Event Handlers;</li>
<li><code>closePc()</code>: force the closure of a PeerConnection;</li>
<li><code>endSession()</code>: force the detach of a plugin handle;</li>
<li><code>configureMedium()</code>: specify whether audio/video/data can be received/sent;</li>
<li><code>addRecipient()</code>: specify which user should receive a user's media;</li>
<li><code>removeRecipient()</code>: specify which user should not receive a user's media anymore;</li>
<li><code>setBitrate()</code>: specify the bitrate to force on a user via REMB feedback;</li>
<li><code>setPliFreq()</code>: specify how often the plugin should send a PLI to this user;</li>
<li><code>setSubstream()</code>: set the target simulcast substream;</li>
<li><code>setTemporalLayer()</code>: set the target simulcast temporal layer;</li>
<li><code>sendPli()</code>: send a PLI (keyframe request);</li>
<li><code>startRecording()</code>: start recording audio, video and or data for a user;</li>
<li><code>stopRecording()</code>: start recording audio, video and or data for a user;</li>
<li><code>pokeScheduler()</code>: notify the C code that there's a coroutine to resume;</li>
<li><code>timeCallback()</code>: trigger the execution of a Lua function after X milliseconds.</li>
</ul>
<p>As anticipated in the previous section, almost all these methods also expect the unique session identifier to address a specific user in the plugin. This is true for all the above methods expect <code>eventsIsEnabled</code> and, more importantly, both <code>timeCallback()</code> and <code>pokeScheduler()</code> which, together with Lua's <code>resumeScheduler()</code>, will be clearer in the next section.</p>
<h1><a class="anchor" id="coroutines"></a>
Lua/C coroutines scheduler</h1>
<p>Lua is a single threaded environment. While it has a concept similar to threads called coroutines, these are not threads as known in C. In order to allow for an easy to implement asynchronous behaviour in Lua scripts, you can leverage a scheduler implemented in the C code.</p>
<p>More specifically, when the plugin starts a dedicated thread is devoted to the only purpose of acting as a scheduler for Lua coroutines. This means that, whenever this C scheduler is awaken, it will call the <code>resumeScheduler()</code> function in the Lua script, thus allowing the Lua script to execute one or more pending coroutines. The C scheduler only acts when triggered, which means it's up to the Lua script to tell it when to wake up: this is possible via the <code>pokeScheduler()</code> function, which does nothing more than sending a simple signal to the C scheduler to wake it up. As such, it's easy for the Lua script to implement asynchronous behaviour, e.g.:</p>
<ol type="1">
<li>Lua script needs to do something asynchronously;</li>
<li>Lua script creates coroutine, and takes note of it somewhere;</li>
<li>Lua script calls <code>pokeScheduler()</code>;</li>
<li>C code sends signal to the thread acting as a scheduler;</li>
<li>when the scheduling thread wakes up, it calls <code>resumeScheduler()</code>;</li>
<li>Lua script resumes the previously queued coroutine.</li>
</ol>
<p>This simple mechanism is what the sample Lua scripts provided in this repo use, for instance, to handle incoming messages asynchronously, so you can refer to those to have an idea of how it can be used. The next section will address <a class="el" href="lua.html#timers">Lua/C time-based scheduler</a> instead.</p>
<dl class="section note"><dt>Note</dt><dd>You can implement asynchronous behaviour any way you want, and you're not required to use this C scheduler. Anyway, you must implement a method called <code>resumeScheduler()</code> anyway, as the C code checks for its presence and fails if it's not there. If you don't need it, just create an empty function that does nothing and you'll be fine.</dd></dl>
<h1><a class="anchor" id="timers"></a>
Lua/C time-based scheduler</h1>
<p>Another helpful way to implement asynchronous behaviour is with the help of the <code>timeCallback()</code> function. Specifically, this function implements a mechanism to ask for a specific Lua method to be invoked after a provided amount of time. To specify the function to invoke, an optional argument to pass (which MUST be a string) and the time to wait to do that. This is particularly helpful when you're handling asynchronous behaviour that you want to inspect on a regular basis.</p>
<p>The <code>timeCallback()</code> function expects three arguments:</p>
<pre class="fragment">timeCallback(function, argument, milliseconds)
</pre><p>The only mandatory parameter is <code>function:</code> if you set <code>argument</code> to <code>nil</code> no argument will be passed to <code>function</code> when it's executed; it <code>milliseconds</code> is 0, <code>function</code> will be executed as soon as possible.</p>
<pre class="fragment">-- This will cause an error (timeCallback needs three arguments)
timeCallback()
-- Invoke test() in 500 milliseconds
timeCallback("test", nil, 500)
-- Invoke test("ciccio") in 2 seconds
timeCallback("test", "ciccio", 2000)
</pre><p>Notice that <code>timeCallback()</code> allows you to formally recreate the mechanism <code>pokeScheduler()</code> and <code>resumeScheduler()</code> implement, as the following is pretty much an equivalent of that:</p>
<pre class="fragment">timeCallback("resumeScheduler", nil, 0)
</pre><p>Anyway, <code>pokeScheduler()</code> and <code>resumeScheduler()</code> is much more compact and less verbose, and as such is preferred in cases where timing and opaque arguments are not needed.</p>
<p>Refer to the <a class="el" href="group__luapapi.html">Lua plugin API</a> section for more information on how you can register your own C functions. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.18-->
<!-- start footer part -->
<div class="footer container">
<hr class="footer"/>
Last updated on Tue Jan 14 2025 &mdash; Janus WebRTC Server &copy; <a target="_blank" href="http://www.meetecho.com/">Meetecho</a> 2014-2024
</div>
</body>
</html>
